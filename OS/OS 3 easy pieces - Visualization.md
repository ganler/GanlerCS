# Visualization

[TOC]

## Process

#### åˆ†ç¦»ç­–ç•¥å’Œæœºåˆ¶

å³å°†**é«˜å±‚ç­–ç•¥**ä¸**åº•å±‚å®ç°**åˆ†å¼€è®¾è®¡ã€‚

#### è¿›ç¨‹åˆ›å»º

- åŠ è½½æ‰€æœ‰å¯¹åº”çš„ä»£ç å’Œé™æ€æ•°æ®åˆ°è¿›ç¨‹å¯¹åº”çš„åœ°å€ç©ºé—´ä¸­ã€‚ï¼ˆlazilyæ‰§è¡Œï¼‰
- åˆ›å»ºè¿è¡Œæ—¶æ ˆï¼Œä¸ºè¿è¡Œæ—¶æ ˆåˆ†é…å†…å­˜
- å¿…è¦çš„è¯ï¼Œåˆ†é…ä¸€å®šçš„å †å†…å­˜
- å…¶ä»–åˆå§‹åŒ–ä»»åŠ¡ï¼ˆå¦‚I/Oï¼‰

#### è¿›ç¨‹çŠ¶æ€

- è¿è¡Œ
- å µå¡
- å°±ç»ª

#### PCB

> ä»¥xv6ä¸ºä¾‹

- ä¸Šä¸‹æ–‡`context`ï¼ˆå„ç§å¯„å­˜å™¨ï¼‰
- è¿›ç¨‹åœ°å€ç©ºé—´ï¼ˆåˆå§‹ä½ç½®ä¸å¤§å°ï¼‰
- å†…æ ¸æ ˆçš„æ ˆåº•åœ°å€
- è¿›ç¨‹çŠ¶æ€
- pid
- çˆ¶è¿›ç¨‹
- chan, killed
- Open file
- å½“å‰è·¯å¾„
- Trap frame

> é™¤äº†ä¸‰å¤§çŠ¶æ€ï¼ˆä¸‰å¤§çŠ¶æ€çš„ç‰¹ç‚¹æ˜¯ä¼šå¤šæ¬¡å‡ºç°ï¼‰è¿˜æœ‰**åˆå§‹çŠ¶æ€**ï¼ˆæ­£åœ¨å»ºç«‹ï¼‰ï¼Œ**åƒµå°¸çŠ¶æ€**ï¼ˆè¿›ç¨‹é€€å‡ºä½†æœªæ¸…ç†ï¼‰ã€‚

#### API

- `fork`ï¼šåˆ›å»ºå­è¿›ç¨‹ï¼Œæ‰§è¡Œå½“å‰çˆ¶è¿›ç¨‹forkåçš„ä»£ç ã€‚

> å­è¿›ç¨‹å¹¶ä¸æ˜¯å®Œæ•´çš„æ‹·è´çˆ¶è¿›ç¨‹ï¼Œå…¶ä»forkè¿”å›çš„å€¼æ˜¯ä¸åŒçš„ã€‚

```c++
#include <cstdio>
#include <unistd.h>

// rc == 0 => å½“å‰è¿›ç¨‹å°±æ˜¯å­è¿›ç¨‹
// rc <  0 => å¤±è´¥

int main()
{
    printf("Now --> pid:%d\n", (int)getpid());
    int rc = fork();
    if( rc < 0 ) // fork failed
        printf("fork failed\n");
    else if( rc == 0 ) // child process
        printf("--> Child: %d\n", (int) getpid());
    else
        printf("--> Father( %d ) of %d\n", (int) getpid(), rc);
}
```

- `wait`

```c++
#include <cstdio>
#include <unistd.h>
#include <sys/wait.h>

// rc == 0 => å½“å‰è¿›ç¨‹å°±æ˜¯å­è¿›ç¨‹
// rc <  0 => å¤±è´¥

int main()
{
    printf("Now --> pid:%d\n", (int)getpid());
    int rc = fork();
    if( rc < 0 ) // fork failed
        printf("fork failed\n");
    else if( rc == 0 ) // child process
        printf("--> Child: %d\n", (int) getpid());
    else
    {
        int wc = wait(NULL); // ç­‰å¾…å­è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚
        printf("--> Father( %d ) of %d\n", (int) getpid(), rc);
    }
}
```

- `exec`

> forkåï¼Œå¯è°ƒç”¨execå»æ‰§è¡Œåˆ«çš„ç¨‹åºã€‚è¿™æ ·ä¸ä¼šäº§ç”Ÿæ–°çš„å­è¿›ç¨‹ã€‚
>
> è°ƒç”¨execåï¼Œå½“å‰å­è¿›ç¨‹çš„ç¨‹åºï¼Œé™æ€æ•°æ®ï¼Œå †ï¼Œæ ˆç­‰éƒ½ä¼šè¢«è¦†ç›–ï¼ˆé‡æ–°åˆå§‹åŒ–ï¼‰ï¼Œç„¶åæ‰§è¡Œexecå¯¹åº”çš„ç¨‹åºã€‚ï¼ˆä½¿ç”¨execä¹‹åï¼Œexecä¹‹åçš„ç¨‹åºéƒ½æ²¡äº†ï¼Œå› ä¸ºå½“å‰è¿›ç¨‹è¢«åˆ·æ–°äº†ï¼Œå…¶ä¹Ÿä¼šæœ‰è¿”å›å€¼ï¼Œä½†æ˜¯æˆåŠŸè°ƒç”¨çš„è¯ä¸ä¼šè¿”å›ï¼‰
>
> <u>å¯¹execçš„æˆåŠŸè°ƒç”¨æ°¸è¿œéƒ½ä¸ä¼šè¿”å›ã€‚</u>

```c++
#include <unistd.h>
#include <cstdio>
#include <sys/wait.h>

int main()
{
    auto fuck = fork();
    char* f[] =  {"echo", "balabala", nullptr};
    if(fuck == 0)
        execvp(f[0], f);
    else
        wait(NULL);
    printf("hello\n"); // å¹¶ä¸ä¼šè¾“å‡º2æ¬¡
}
```

```c++
#include <unistd.h>
#include <cstdio>
#include <sys/wait.h>

int main()
{
    auto fuck = fork();
    char* f[] =  {"echo1", "balabala", nullptr}; // é”™è¯¯
    if(fuck == 0)
        execvp(f[0], f);
    else
        wait(NULL);
    printf("hello\n"); // è¾“å‡º2æ¬¡
}
```

```c++
#include <cstdio>
#include <unistd.h>
#include <sys/wait.h>
#include <cstring>

// rc == 0 => å½“å‰è¿›ç¨‹å°±æ˜¯å­è¿›ç¨‹
// rc <  0 => å¤±è´¥

int main()
{
    printf("Now --> pid:%d\n", (int)getpid());
    int rc = fork();
    if( rc < 0 ) // fork failed
        printf("fork failed\n");
    else if( rc == 0 ) // child process
    {
        printf("--> Child: %d\n", (int) getpid());
        char* args[3] = {
                strdup("wc"),
                strdup("../util.hpp"),
                nullptr
        };
        execvp(args[0], args);
        printf("child is doing sth\n");
    }
    else
    {
        int wc = wait(NULL); // ç­‰å¾…å­è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚
        printf("--> Father( %d ) of %d\n", (int) getpid(), rc);
    }
}
```

#### Shell

- shellä¹Ÿæ˜¯ä¸€ä¸ªç¨‹åºï¼Œæˆ‘ä»¬é€šè¿‡ä¼ å…¥shellå‘½ä»¤ï¼Œshellæ”¶åˆ°å‘½ä»¤åforkå†execï¼ˆçš„æŸä¸ªå˜ä½“ï¼‰ï¼Œå†è°ƒç”¨waitç­‰å¾…è¿›ç¨‹ç»“æŸã€‚
- **é‡å®šå‘çš„å®ç°**ï¼šè°ƒç”¨execå‰å…³é—­stdioï¼Œæ‰“å¼€ç›®æ ‡æ–‡ä»¶ï¼Œç„¶åè¾“å‡ºåˆ°è¯¥æ–‡ä»¶ä¸Šã€‚

```c++
#include <fcntl.h>

// ...

close(STDOUT_FILENO);
open(output_file, O_CREAT | O_WRONLY | O_TRUNC, S_IRWXU);

// ...
```

- UNIXç®¡é“ï¼Œä½¿ç”¨äº†pipe()ç³»ç»Ÿè°ƒç”¨ã€‚ä¸€ä¸ª**è¿›ç¨‹çš„è¾“å‡º**è¢«é“¾æ¥åˆ°äº†ä¸€ä¸ªå†…æ ¸ç®¡é“ä¸Šï¼ˆé˜Ÿåˆ—ï¼‰ï¼Œå¦å¤–ä¸€ä¸ª**è¿›ç¨‹çš„è¾“å…¥**ä¹Ÿè¢«é“¾æ¥åˆ°äº†ä¸€ä¸ªå†…æ ¸ç®¡é“ä¸Šã€‚ç„¶åç›¸äº’matchï¼Œä»¥å®ç°ç®¡é“ã€‚`grep -r main ./* | wc -l`ã€‚

#### å—é™ç›´æ¥æ‰§è¡Œ

è™šæ‹ŸåŒ–æœºåˆ¶çš„2å¤§é‡ç‚¹ï¼š

- æ§åˆ¶æƒï¼ˆä¿è¯æ“ä½œç³»ç»Ÿè‡ªç”Ÿçš„æ§åˆ¶æƒï¼‰
- é«˜æ€§èƒ½ï¼ˆå°½é‡æ¥è¿‘zero-overheadï¼‰

> ç›´æ¥è¿è¡Œåè®®ï¼ˆæ— é™åˆ¶ï¼‰

|                              OS                              |          Program          |
| :----------------------------------------------------------: | :-----------------------: |
| åœ¨è¿›ç¨‹åˆ—è¡¨ä¸Šåˆ›å»ºæ¡ç›®<br />ä¸ºç¨‹åºåˆ†é…å†…å­˜<br />åŠ è½½ç¨‹åºå’Œé™æ€æ•°æ®<br />æ ¹æ®argc/argvè®¾ç½®è¿è¡Œæ—¶æ ˆ<br />æ¸…ç©ºå¯„å­˜å™¨<br />call main |                           |
|                                                              | æ‰§è¡Œmain<br />return main |
|               é‡Šæ”¾è¿›ç¨‹å†…å­˜ï¼Œå¹¶ä»è¿›ç¨‹åˆ—è¡¨ä¸­ç§»é™¤               |                           |

> ç›´æ¥è¿è¡Œçš„ä¼˜ç‚¹æ˜¯å¿«é€Ÿï¼Œä½†è¿™æ ·æ— æ³•è¿›è¡Œå—é™æ“ä½œï¼ˆå› ä¸ºæ“ä½œç³»ç»Ÿä»£ç æ— æ³•æ§åˆ¶ï¼‰ã€‚

> **å—é™æ“ä½œ**ï¼š
>
> åŒºåˆ†ç”¨æˆ·æ¨¡å¼å’Œå†…æ ¸æ¨¡å¼ï¼šç”¨æˆ·æ¨¡å¼ä¸èƒ½å®Œå…¨è®¿é—®èµ„æºï¼Œè€Œå†…æ ¸æ¨¡å¼å¯ã€‚å†…æ ¸é€šè¿‡â€œç³»ç»Ÿè°ƒç”¨â€å‘ç”¨æˆ·ä»£ç æä¾›ä¸€äº›ç‰¹æ®Šçš„å—é™åŠŸèƒ½ã€‚
>
> > è¦æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œç¨‹åºå¿…é¡»æ‰§è¡Œç‰¹æ®Šçš„**<u>é™·é˜±æŒ‡ä»¤</u>**ã€‚
> >
> > - è°ƒç”¨ç³»ç»Ÿè°ƒç”¨ -> **é™·å…¥å†…æ ¸(trap)**
> > - å°†ç‰¹æƒçº§åˆ«æå‡ä¸ºå†…æ ¸æ¨¡å¼
> > - è¿”å› -> **é™·é˜±è¿”å›(return-from-trap)**
> > - é™ä½ç‰¹æƒçº§åˆ«
>
> > x86æ¶æ„åœ¨è¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ä¼šæŠŠå¯„å­˜å™¨pushåˆ°**å†…æ ¸æ ˆ**ä¸Šï¼Œè¿”å›æ—¶å†popã€‚
>
> > trapåï¼Œæ“ä½œç³»ç»Ÿæ ¹æ®ä¸åŒçš„å¼‚å¸¸ç ï¼Œæ‰¾åˆ°å¯¹åº”çš„å†…æ ¸ä»£ç å¹¶æ‰§è¡Œã€‚è¿™ä¸ªæ‰¾çš„è¿‡ç¨‹ï¼Œé çš„æ˜¯é™·é˜±è¡¨(trap table)ï¼Œé™·é˜±è¡¨ç”±æ“ä½œç³»ç»Ÿåœ¨å¼€æœºåˆå§‹åŒ–çš„æ—¶å€™å¯¹ç¡¬ä»¶è¿›è¡Œé…ç½®ï¼Œè€Œè·³è½¬çš„è¿‡ç¨‹æ˜¯é€šè¿‡CPUçš„ä¸€äº›ç‰¹æ®ŠæŒ‡ä»¤å®Œæˆçš„ã€‚

> **å—é™æ‰§è¡Œåè®®ï¼ˆLDEï¼‰**

![](https://i.loli.net/2019/09/21/MFwcDOXHepyGgfi.png)

> https://www.kernel.org/doc/html/latest/x86/kernel-stacks.html
>
> https://stackoverflow.com/questions/12911841/kernel-stack-and-user-space-stack
>
> > In a Linux system, every user process has 2 stacks, a user stack and a dedicated kernel stack for the process. The user stack resides in the user address space (first 3GB in 32-bit x86 arch.) and the kernel stack resides in the kernel address space (3GB-4GB in 32bit-x86) of the process.
> >
> > When a user process needs to execute some privileged instruction (a system call) it traps to kernel mode and the kernel executes it on behalf of the user process. **This execution takes place on the process' kernel stack.**
> >
> > The [**TSS (Task State Segment)**](https://en.wikipedia.org/wiki/Task_state_segment) is used to store the segment selector and stack pointer of the process' kernel stack.
> >
> > Upon a system call, the user process pushes all caller save registers in the process' user stack and executes [**int $0x80**](https://en.wikipedia.org/wiki/INT_(x86_instruction)) (0x80 is for system call**)** instruction. Then the **hardware** (not software) finds the process' kernel stack address from the TSS, loads those values to %**ss** (stack segment selector ) and pushes the old stack stack-pointer (**%esp**), old program-counter (**%eip**), old stack segment (**%ss**), code segment(**%cs**), and EFLAGS registers in the **process' kernel stack.** Hence, any operation requiring stack access uses this stack (not the user stack). After execution is over, the hardware pops the saved values from the kernel stack to their respective registers and resumes in the user stack.
> >
> > For a trap execution, the user stack can't be used because it might be corrupted by malicious user process. The kernel stack is used by kernel code only, so it is safe.
> >
> > X86æœ‰ä¸ªå«åšTaskStateSegmentçš„ç¡¬ä»¶ï¼Œä¿å­˜äº†å½“å‰è¿›ç¨‹çš„Kstackçš„ä½ç½®ã€‚åœ¨è¿›å…¥å†…æ ¸æ€çš„æ—¶å€™ï¼Œç¡¬ä»¶é€šè¿‡TSSæ‰¾åˆ°å†…æ ¸æ ˆï¼ˆ%ssï¼‰ï¼Œç„¶åå°†ss & esp & eip & cs & eflags pushåˆ°å†…æ ¸æ ˆã€‚

#### User stack & kernel stack

åœ°å€ä¸ä¸€æ ·ï¼Œæƒé™ä¸ä¸€æ ·ã€‚

- User stackåœ¨ç”¨æˆ·æ€
- Kernel stackåœ¨å†…æ ¸æ€
- æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªkernel stack
- syscallçš„æ—¶å€™ï¼Œé€šè¿‡ç¡¬ä»¶ï¼Œå¯„å­˜å™¨dataå°†è¿›è¡Œæš‚æ—¶çš„å­˜å‚¨å’Œæ¢å¤

#### ç­‰å¾…ç³»ç»Ÿè°ƒç”¨çš„åä½œæ–¹å¼

> å³OSç›¸ä¿¡ç¨‹åºä¼šå®šæœŸgive upã€‚
>
> - yield
> - I/O
> - å‘ç”Ÿé”™è¯¯ï¼Œé™·å…¥trap
> - å…¶ä»–ç³»ç»Ÿè°ƒç”¨

#### æ“ä½œç³»ç»Ÿå¹²é¢„çš„éåä½œæ–¹å¼

ä¾é æ—¶é’Ÿä¸­æ–­ï¼Œå³è¿è¡Œä¸€æ®µæ—¶é—´ï¼ˆä¸€èˆ¬æ˜¯å‡ æ¯«ç§’å°±ä¸­æ–­ä¸€æ¬¡ï¼‰ã€‚ä¸­æ–­çš„æ—¶å€™ï¼ŒOSå°±å¯ä»¥è·å¾—æ“æ§æƒäº†ã€‚ï¼ˆå½“ç„¶æ“ä½œç³»ç»Ÿä¹Ÿå¯ä»¥å…³ä¸­æ–­->ç‰¹æƒæ“ä½œï¼‰

#### ä¸Šä¸‹æ–‡åˆ‡æ¢

å†…æ ¸æ ˆpush&popã€‚

![](https://i.loli.net/2019/09/21/OZchYsWv8CnGKf3.png)

> æ³¨æ„ï¼Œå¯„å­˜å™¨è¢«ä¿å­˜å’Œæ¢å¤æœ‰2ç§æ–¹å¼ï¼š
>
> - ç¡¬ä»¶éšå¼ä¿å­˜ï¼ˆç›®æ ‡åœ°å€æ˜¯å†…æ ¸æ ˆï¼Œç”±ç¡¬ä»¶å®ç°ï¼‰ï¼›
> - æ“ä½œç³»ç»Ÿæ˜¾å¼ä¿å­˜ï¼ˆç›®æ ‡åœ°å€æ˜¯PCBçš„å†…å­˜ï¼Œlinux3.6å†…æ ¸ä»£ç `switch_to`ä¸­çš„æ³¨é‡Šè¡¨ç¤ºï¼‰ï¼›
>
> > Andï¼Œcontextæ˜¯ç”¨äºç”¨æˆ·è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œk-stackæ˜¯ç”¨ä¸å†…æ ¸æ€ä¸ç”¨æˆ·æ€çš„åˆ‡æ¢ã€‚

```c
/*
 * Context-switching clobbers all registers, so we clobber      \
 * them explicitly, via unused output variables.                \
 * (EAX and EBP is not listed because EBP is saved/restored     \
 * explicitly for wchan access and EAX is the return value of   \
 * __switch_to())           
 */
```

> > å†æ¬¡æ³¨æ„ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰2ç§ç±»å‹çš„stackï¼Œuser-modeå’Œkernel-modeï¼Œkernel-mode stackå°±æ˜¯æˆ‘ä»¬è¯´å†…æ ¸æ ˆã€‚
> >
> > Each user thread has both a **user-mode** stack and a **kernel-mode** stack. When a thread enters the kernel, the current value of the <u>user-mode stack</u> (`SS:ESP`) and <u>instruction pointer</u> (`CS:EIP`) are saved to the thread's <u>kernel-mode stack,</u> and the CPU switches to the kernel-mode stack - with the `int $80` syscall mechanism, this is done by the CPU itself. <u>The remaining register values and flags are then also saved to the kernel stack.</u>
> >
> > When a thread context-switches, it calls into the scheduler (the scheduler does not run as a separate thread - <u>it always runs in the context of the current thread</u>). The scheduler code selects a process to run next, and calls the `switch_to()` function. This function essentially just switches the kernel stacks - it saves <u>the current value of the stack pointer into the TCB</u> for the current thread (called `struct task_struct` in Linux), and loads a previously-saved stack pointer from the TCB for the next thread. At this point it also saves and restores some other thread state that isn't usually used by the kernel - things like floating point/SSE registers. <u>If the threads being switched don't share the same virtual memory space (ie. they're in different processes), the page tables are also switched.</u>
> >
> > So you can see that the core user-mode state of a thread isn't saved and restored at context-switch time - it's saved and restored to the thread's kernel stack <u>when you enter and leave the kernel.</u> The context-switch code doesn't have to worry about clobbering the user-mode register values - those are already safely saved away in the kernel stack by that point.

#### ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€

- 200-MHz Linux 1.3.37 ~ ç³»ç»Ÿè°ƒç”¨ 3Î¼s ä¸Šä¸‹æ–‡åˆ‡æ¢6Î¼s
- å†…æ ¸ä¸èƒ½è¢«æŠ¢å å¼è°ƒåº¦ï¼ˆæŠ¢å å¼çš„è°ƒåº¦éƒ½æ˜¯ä¸€ä¸ªè¦è¿”å›ç”¨æˆ·æ€çš„è¿›ç¨‹åœ¨æŠ¢ï¼‰

> ç†è®ºåˆ†æï¼š
>
> - å¯„å­˜å™¨çš„ä¿å­˜ä¸æ¢å¤
> - Cacheåˆ·æ–°
> - æµæ°´çº¿ï¼Œåˆ†æ”¯é¢„æµ‹ç»“æœåˆ·æ–°
> - TLBï¼ˆçº¿ç¨‹çº§åˆ«å¯ä¸è€ƒè™‘ï¼‰

#### x86ç¡¬ä»¶æ”¯æŒ

- IDT
- å°†å¯„å­˜å™¨ä¿å­˜åˆ°å†…æ ¸æ ˆ
  - user-mode->kernel-mode: `EIP,CS; ESP,SS; EFLAGS`
  - Kernel-mode->user-mode: `EIP, CS; EFLAGS`

## è¿›ç¨‹è°ƒåº¦

åœ¨è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶å€™ï¼Œå¦‚ä½•é€‰æ‹©å³å°†è¦åˆ‡æ¢åˆ°çš„è¿›ç¨‹ï¼Œæ¶‰åŠçš„å°±æ˜¯è¿›ç¨‹è°ƒåº¦çš„é—®é¢˜äº†ã€‚

> è°ƒåº¦é—®é¢˜2å¤§aimï¼šå…¬å¹³+æ€§èƒ½ï¼›

#### æŒ‡æ ‡

- å¸Œæœ›å°½æ—©å®Œæˆï¼ˆæ€§èƒ½ï¼‰ï¼šå‘¨è½¬æ—¶é—´=å®Œæˆæ—¶é—´-åˆ°è¾¾æ—¶é—´
- å¸Œæœ›å°½æ—©è¢«å“åº”ï¼ˆå…¬å¹³+æ€§èƒ½ï¼‰ï¼šå“åº”æ—¶é—´=é¦–æ¬¡è¿è¡Œæ—¶é—´-åˆ°è¾¾æ—¶é—´ï¼ˆé€‚ç”¨äºå¯¹æ—¶é—´æ•æ„Ÿçš„ç¨‹åºï¼‰

#### ç­–ç•¥

- FIFO
- SJFï¼ˆshortest job firstï¼‰ï¼šæœ€ä¼˜ï¼Œå¹³å‡å‘¨è½¬æ—¶é—´æœ€çŸ­ï¼ˆåŒæ—¶åˆ°è¾¾è¿›ç¨‹ç”±å¼€å§‹åˆ°è¢«è°ƒåº¦å®Œçš„æ—¶é—´æ€»åˆ/è¢«è°ƒåº¦è¿›ç¨‹æ•°é‡ï¼‰ï¼ˆ$T=Nt_1+(N-1)t_2+\cdots+t_N$ï¼‰

> ç¼ºç‚¹ï¼šéæŠ¢å å¼ï¼Œè‹¥æœ‰æ–°çš„çŸ­æ—¶é—´è¿›ç¨‹æ¥äº†ï¼Œè¿˜æ˜¯ä¼šè®©è€è¿›ç¨‹å…ˆæ‰§è¡Œã€‚

- STCFï¼ˆæœ€çŸ­å®Œæˆæ—¶é—´ä¼˜å…ˆShortest Time-to-Completion Firstï¼‰ï¼šæŠ¢å å¼ã€‚åŒæ ·æ˜¯æœ€ä¼˜çš„ã€‚
- RR(Round-Robin è½®è½¬)ï¼šè§£å†³çš„æ˜¯å“åº”æ—¶é—´çš„é—®é¢˜ã€‚ï¼ˆå¯¹å‘¨è½¬æ—¶é—´ä¸å‹å¥½ï¼Œä½†ç¬¦åˆå…¬å¹³æ€§ï¼‰
- Overlap I/O

#### é—®é¢˜

ä¸Šé¢å¾ˆå¤šç­–ç•¥æ˜¯å‡è®¾æˆ‘ä»¬çŸ¥é“æ•´ä¸ªè¿è½¬æ—¶é—´çš„é•¿åº¦ï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬å¹¶æ— æ³•çŸ¥é“â€¦æ‰€ä»¥æˆ‘ä»¬åº”è¯¥åˆ©ç”¨æœ€è¿‘çš„ç­–ç•¥å»é¢„æµ‹æœªæ¥â€¦ï¼ˆå¤šçº§åé¦ˆé˜Ÿåˆ—ï¼‰

## MLFQ å¤šçº§åé¦ˆé˜Ÿåˆ—

#### è®¾è®¡åˆè¡·

- naiveä½¿ç”¨åˆ†æ—¶ç­–ç•¥ä¼šå¯¼è‡´**å‘¨è½¬æ—¶é—´**ä¸ä½³
- ä½¿ç”¨å…¶ä»–çš„ç­–ç•¥**å“åº”æ—¶é—´**

> å—¯ï¼Œå°±æ˜¯æ‹¿æ¥æƒè¡¡å‘¨è½¬æ—¶é—´å’Œå“åº”æ—¶é—´çš„ã€‚

#### è§„åˆ™

1. ğŸŒŸ æŒ‰ä¼˜å…ˆçº§æ‰§è¡Œ
2. ğŸŒŸ åŒä¼˜å…ˆçº§åˆ™è½®è½¬
3. ğŸŒŸ æ–°ä»»åŠ¡ä»æœ€é«˜ä¼˜å…ˆçº§å¼€å§‹
4. ğŸŒŸ ä½¿ç”¨å®Œä¸€ä¸ªæ—¶é—´ç‰‡åˆ™é™ä½ä¸€æ¬¡ä¼˜å…ˆçº§
5. ğŸŒŸ å› ä¸ºå…¶ä»–åŸå› ï¼ˆæ¯”å¦‚IOï¼‰è€Œé‡Šæ”¾CPUåˆ™ä¸æ”¹å˜ä¼˜å…ˆçº§ï¼ˆå¯¹äºäº¤äº’å‹çš„è¿›ç¨‹ï¼Œç”±äºæˆ‘ä»¬å¸Œæœ›å®ƒè¢«å³ä½¿å“åº”ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›å®ƒä¼˜å…ˆçº§é«˜ï¼‰

> åªè¦è°ƒåº¦ä¸æ˜¯ç‰¹åˆ«é¢‘ç¹ï¼Œé‚£ä¹ˆç›¸å¯¹æ¥è¯´è°ƒåº¦çš„å¼€é”€å°±å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚

#### é—®é¢˜

- æ¶æ„ç¨‹åºå¯ä»¥é€šè¿‡é¢‘ç¹IOæ¥æŠ¢å ä¼˜å…ˆçº§ï¼ˆæ„šå¼„é—®é¢˜ï¼‰
- å¦‚æœâ€œéäº¤äº’â€å‹è¿›ç¨‹çªç„¶å˜æˆâ€œäº¤äº’å‹â€è¿›ç¨‹ï¼Œé‚£ä¹ˆå“åº”çš„é—®é¢˜è¿˜æ˜¯æ²¡æœ‰è¢«è§£å†³

#### æ”¹è¿›ï¼šæå‡ä¼˜å…ˆçº§

- æ€è·¯ä¸€ï¼šå‘¨æœŸæ€§æå‡æ‰€æœ‰å·¥ä½œçš„ä¼˜å…ˆçº§ï¼ˆé’ˆå¯¹é—®é¢˜2ï¼‰
- ğŸŒŸ ç»è¿‡ä¸€æ®µæ—¶é—´ï¼ˆJohn Ousterhoutç§°ä¹‹ä¸ºâ€œå·«æ¯’å¸¸é‡(voo-doo constant)â€ï¼‰ï¼Œç³»ç»Ÿå°†æ‰€æœ‰å·¥ä½œé‡æ–°åŠ å…¥æœ€é«˜ä¼˜å…ˆé˜Ÿåˆ—ã€‚
- æ€è·¯äºŒï¼šæ›´å¥½çš„è®¡æ—¶æ–¹å¼ï¼ˆè§£å†³æ„šå¼„é—®é¢˜ï¼‰

> è¦è§£å†³æ„šå¼„é—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆå¾—è§£é™¤â€œå‘ç”ŸIOä¸é™ä½ç­‰çº§â€çš„é­”å’’ï¼Œç„¶åå†ä¿è¯å…¬å¹³ï¼Œé‚£ä¹ˆä¹…é‡æ–°è§„å®šè®¡æ—¶æ–¹å¼ã€‚

- ä¹‹å‰çš„è®¡æ—¶ï¼šã€è°ƒåº¦æ—¶é‡æ–°è®¡æ—¶ã€‘ç»™å®šæ—¶é—´ç‰‡ï¼Œæ—¶é—´ç‰‡ç»“æŸæˆ–å‘ç”Ÿä¸­æ–­é‡æ–°è®¡æ—¶ã€‚+ä¸­æ–­ä¸é™çº§
- æ–°çš„è®¡æ—¶ï¼šã€æ¯ä¸ªä»»åŠ¡å¯¹åº”ä¸€ä¸ªæ—¶é—´ã€‘ç»´æŠ¤æ—¶é—´ï¼Œåªæœ‰å½“ä¸€ä¸ªè¿›ç¨‹å½»å½»åº•åº•çš„ç”¨å®Œä¸€ä¸ªæ—¶é—´ç‰‡æ‰é™çº§ã€‚
- ğŸŒŸ ä¸€æ—¦ä¸€ä¸ªå·¥ä½œå®Œæˆäº†å…¶åœ¨**<u>æŸä¸€å±‚</u>**ä¸­çš„**æ—¶é—´é…é¢**ï¼Œé‚£ä¹ˆå°±é™ä½ä¼˜å…ˆçº§ã€‚ï¼ˆé’ˆå¯¹é—®é¢˜ä¸€ï¼‰

> ä¹‹å‰çš„æ—¶é—´ç‰‡æ˜¯åŒ…æ‹¬IOç­‰å…¶ä»–æ“ä½œçš„ï¼Œè€Œæ–°çš„æ—¶é—´é…é¢æ˜¯æŸä¸€çº§æŒ‡ç”¨äºâ€œrunningâ€çš„æ—¶é—´ã€‚

#### é…ç½®

- æå‡ä¼˜å…ˆçº§çš„æ—¶é—´å‘¨æœŸçš„è®¾ç½®
- ä¼˜å…ˆé˜Ÿåˆ—çš„å±‚æ•°
- ï¼ˆæ¯ä¸€å±‚ï¼‰æ—¶é—´ç‰‡å¤§å°

> ä¸€èˆ¬æ¥è¯´MLFQè¶Šé«˜ä¼˜å…ˆçº§ï¼Œæ—¶é—´ç‰‡è¶ŠçŸ­ï¼ˆå“åº”å¿«ï¼‰ï¼Œè¶Šä½åˆ™æ—¶é—´ç‰‡è¶Šé•¿ã€‚

#### Ousterhoutå®šå¾‹

å°½é‡é¿å…å·«æ¯’å¸¸é‡ï¼ˆvoo-doo constantï¼‰ã€‚

#### å®ç°

- Solaris: è¡¨ï¼ˆé…ç½®ï¼‰ï¼Œé»˜è®¤60å±‚â€¦ï¼Œ20ms~å‡ ç™¾msï¼Œæ¯ä¸€ç§’åˆ·æ–°ä¸€æ¬¡ä¼˜å…ˆçº§ã€‚
- å…¶ä»–ï¼šæ•°å­¦å…¬å¼è°ƒæ•´ä¼˜å…ˆçº§ã€‚â€”â€”FreeBSDï¼ŒåŸºäºå½“å‰è¿›ç¨‹ä½¿ç”¨äº†å¤šå°‘CPUï¼Œç„¶åæœ‰ä¸ªè®¡ç®—ä¼˜å…ˆçº§çš„å…¬å¼ã€‚

#### ç³»ç»Ÿè®¾è®¡çš„big idea

- ä½¿ç”¨hintï¼Œé€šè¿‡å¯¹hintçš„å¤„ç†ï¼Œæ¥é€‰æ‹©æ›´ä¼˜çš„ç­–ç•¥ï¼›

#### æ€»ç»“

- åˆå§‹éƒ½åœ¨æœ€é«˜ä¼˜å…ˆçº§
- åŒä¼˜å…ˆçº§ä½¿ç”¨æ—¶é—´ç‰‡è½®è½¬
- æ—¶é—´é…é¢â€”â€”è®°å½•**<u>æŸä¸€çº§</u>**ä¼˜å…ˆé˜Ÿåˆ—çš„**<u>çœŸæ­£çš„CPU run time</u>**
- é€šè¿‡ä¸€æ®µæ—¶é—´å°±åˆ·æ–°å·¥ä½œé˜Ÿåˆ—

> æ²¡é”™ä»–æ˜¯åé¦ˆï¼ˆè‡ªé€‚åº”ï¼‰çš„ï¼ï¼ï¼

## åŸºäºå½©ç¥¨æœºåˆ¶çš„è°ƒåº¦

> è¿™ç§æœºåˆ¶å¯ä»¥ç”¨äºâ€œèµ„æºåˆ†é…â€çš„å„ä¸ªé—®é¢˜ä¸Šã€‚
>
> ä¸»é¢˜ï¼š**<u>ä¸€åˆ‡ä¸ºäº†å…¬å¹³ã€‚</u>**

#### ç›®çš„

æ¢ä¸€ä¸ªç›®æ ‡å‡½æ•°ï¼š**<u>è®¤ä¸ºè°ƒåº¦ç¨‹åºçš„æœ€ç»ˆç›®æ ‡ï¼Œæ˜¯ç¡®ä¿æ¯ä¸ªå·¥ä½œè·å¾—ä¸€å®šæ¯”ä¾‹çš„CPUæ—¶é—´ã€‚</u>**

#### How

æ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸€å®šé‡çš„å½©ç¥¨ï¼ŒæŒ‰æŸä¸€è¿›ç¨‹å½©ç¥¨å æ‰€æœ‰è¿›ç¨‹å½©ç¥¨çš„æ¯”ä¾‹ä½œä¸º **è¢«è°ƒåº¦çš„æ¦‚ç‡**ã€‚

éœ€è¦çš„ä¸œè¥¿ï¼š

> - éšæœºæ•°ç”Ÿæˆå™¨
> - è¿›ç¨‹åˆ—è¡¨

> **å½©ç¥¨æŠ½å¥–ç³»ç»Ÿçš„é«˜æ•ˆå®ç°**ï¼šå¯¹äºé€šè¿‡

#### éšæœºæ€§æ˜¯ä¸ªå¥½ä¸œè¥¿

æ—¢ç„¶èŠåˆ°æ¦‚ç‡ï¼Œé‚£ä¹ˆå°±æœ‰éšæœºæ•°ã€‚éšæœºæ•°æ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œèƒ½å¤Ÿå¸®åŠ©ç³»ç»Ÿä»éš¾ä»¥é‡åˆ°çš„â€œéº»çƒ¦çš„è¾¹è§’æƒ…å†µâ€ä¸­è§£æ•‘å‡ºæ¥ã€‚

#### æ›´å¤šç‰¹æ€§

- å½©ç¥¨è½¬è®©ï¼ˆåœ¨server-clientæ¨¡å‹ä¸­å¯ä»¥é€šè¿‡è½¬è®©æå‡ä¸¤ç«¯æ€§èƒ½ï¼‰
- å½©ç¥¨é€šèƒ€ï¼ˆä¸€ä¸ªè¿›ç¨‹å¯ä»¥ä¸´æ—¶å¢åŠ æˆ–å‡å°‘è‡ªå·±çš„å½©ç¥¨æ•°é‡ï¼‰

#### Metric

> å¯¹äºä¸¤ä¸ªåŒç­‰çº§çš„ä»»åŠ¡ï¼šå…¶å®Œæˆ**æ—¶åˆ»**ä¹‹æ¯”ä¸ºæˆ‘ä»¬è¯´çš„ä¸å…¬å¹³æŒ‡æ ‡ã€‚ï¼ˆè¶Šé è¿‘1è¶Šå…¬å¹³ï¼‰

$$
U=\frac{T_1}{T_2}
$$

## æ­¥é•¿è°ƒåº¦ï¼šæ›´åŠ å…¬å¹³

è®°å½•æ¯ä¸ªè¿›ç¨‹çš„è¡Œç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹æ‰§è¡Œä¸€æ¬¡ï¼š`è¡Œç¨‹ += æ­¥é•¿`ã€‚

- è¿›ç¨‹æ­¥é•¿ä¸å½©ç¥¨æ•°æˆåæ¯”ï¼›
- æ¯æ¬¡è°ƒåº¦æ—¶ï¼Œé€‰æ‹©**<u>è¡Œç¨‹çŸ­</u>**çš„è¿›ç¨‹ï¼Œå°†å…¶åŠ å…¥è°ƒåº¦é˜Ÿåˆ—çš„é˜Ÿé¦–ï¼›

## è¿›ç¨‹è°ƒåº¦æ€»ç»“

- å½©ç¥¨è°ƒåº¦ï¼šä¸éœ€è¦ä¿®æ”¹å…¨å±€çŠ¶æ€ï¼Œåªéœ€è¦åœ¨åŠ å…¥è¿›ç¨‹çš„æ—¶å€™ç»™å½©ç¥¨å°±å¥½ï¼Œç„¶åå°±èƒ½åšå†³å®šäº†ï¼›
- MLFQï¼šç¬¦åˆä½å‘¨è½¬æ—¶é—´ï¼Œä½å“åº”æ—¶é—´çš„è¦æ±‚ï¼›
- æ­¥é•¿è°ƒåº¦ï¼šå…¬å¹³ï¼›

> å½©ç¥¨è°ƒåº¦å’Œæ­¥é•¿è°ƒåº¦éƒ½æ˜¯è¯•å›¾ä¿è¯æ¯”ä¾‹ç¬¦åˆé¢„æœŸã€‚

## åœ°å€ç©ºé—´

#### ä¸Šå¤æ—¶ä»£

- æ“ä½œç³»ç»Ÿæ˜¯ä¸ªåº“ï¼Œä¸€å°PCä¸€ä¸ªç¨‹åºï¼Œç›´æ¥ç”¨ç‰©ç†åœ°å€ï¼›

#### å› ä¸ºæ˜‚è´µæ‰€ä»¥å…±äº«

- å¤šé“ç¨‹åº
- æ—¶åˆ†å…±äº«ï¼ˆæé«˜äº¤äº’æ€§ï¼‰

> é‚£ä¹ˆå†…å­˜å‘¢ï¼Ÿ
>
> å½“æ—¶æ˜¯ç›´æ¥è®©ä¸€ä¸ªè¿›ç¨‹ç‹¬å ä¸€æ®µæ—¶é—´çš„å†…å­˜ï¼Œå…¶ä»–çš„ä¸œè¥¿å…ˆä¿å­˜åˆ°ç£ç›˜ã€‚é—®é¢˜å°±æ˜¯æ•ˆç‡å¤ªä½äº†ï¼ˆä½¿ç”¨çš„å†…å­˜è¶Šå¤šï¼Œåˆ‡æ¢æ•ˆç‡è¶Šä½ï¼‰ã€‚
>
> æ‰“ç ´è¿™ç‚¹éœ€è¦è®© ***å¤šä¸ªè¿›ç¨‹åŒæ—¶ä½¿ç”¨å†…å­˜***ã€‚æ–°çš„é—®é¢˜ä¹Ÿæ¥äº†ï¼Œå¦‚ä½•ä¿æŠ¤å„ä¸ªè¿›ç¨‹ã€‚

#### åœ°å€ç©ºé—´

å¯¹ç‰©ç†å†…å­˜çš„åœ°å€åšä¸€å±‚æŠ½è±¡ï¼Œå¾—åˆ°è™šæ‹ŸåŒ–åçš„åœ°å€ç©ºé—´ã€‚

- é™æ€æ•°æ®
- ä»£ç 
- æ ˆ
- å †

#### ç©ºé—´è™šæ‹ŸåŒ–çš„ç›®æ ‡

- ç§æœ‰
- å°½å¯èƒ½å¤§

> å…¶å®ç°ä¹Ÿæ˜¯éœ€è¦ä¾æ‰˜ç¡¬ä»¶ï¼›

#### éš”ç¦»

éš”ç¦»æ˜¯å¯é systemçš„ä¸€ä¸ªå…³é”®åŸåˆ™ã€‚ç›®çš„æ˜¯å‡å°‘ä¸ªä½“ä¹‹å‰çš„å½±å“ï¼ˆè¿›ç¨‹Aç‚¸äº†ï¼Œä¸ä¼šå½±å“è¿›ç¨‹Bï¼‰ã€‚

#### ç©ºé—´è™šæ‹ŸåŒ–çš„å…¶ä»–ç›®æ ‡

- é€æ˜æ€§

å› ä¸ºæ˜¯é€æ˜çš„ï¼Œæ‰€ä»¥è¿›ç¨‹è¦åšåˆ°â€œç›¸ä¿¡ç›¸ä¿¡æ“ä½œç³»ç»Ÿçš„éª—å±€â€ã€‚ï¼ˆå†™ä¸€æ®µæ‰“å°åœ°å€çš„ç¨‹åºæ‰“å°çš„æ˜¯è™šæ‹Ÿåœ°å€ï¼‰

- é«˜æ€§èƒ½ï¼ˆæ—¶é—´å’Œç©ºé—´ï¼‰
- ä¿æŠ¤éš”ç¦»

#### GLIBC Malloc

ä¸ºå­—ç¬¦ä¸²åˆ†é…å†…å­˜çš„æ—¶å€™åº”è¯¥å¤šåˆ†é…ä¸€ä¸ª`byte`ã€‚

## åœ°å€è½¬æ¢

- ç¨‹åºæ¯æ¬¡è®¿é—®å†…å­˜ï¼Œç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿéƒ½éœ€è¦å°†è™šæ‹Ÿåœ°å€è½¬ç‰©ç†åœ°å€ï¼Œåä¹‹äº¦ç„¶ã€‚

#### åŠ¨æ€é‡å®šä½

> é€šè¿‡MMU(Memory Management Unit)çš„**åŸºå€å¯„å­˜å™¨**ï¼ˆè™šæ‹ŸåŒ–ï¼‰+**ç•Œé™å¯„å­˜å™¨**ï¼ˆä¿æŠ¤ï¼‰ï¼Œæ¥å®ç°åœ°å€è™šæ‹ŸåŒ–ã€‚
>
> `physical addr = virtual addr + %base`

> é™æ€é‡å®šä½ï¼Œå³åœ¨ç¨‹åºè·‘ä¹‹å‰å°±å®šä½ï¼Œä»–çš„ç¼ºç‚¹æ˜¯ä¸æä¾›ä¿æŠ¤ï¼ˆç¡¬ä»¶å±‚é¢çš„ä¿æŠ¤ï¼‰ã€‚ç¨‹åºè¿˜æ˜¯å¯ä»¥éšæ„è®¿é—®å…¶ä»–ç¨‹åºã€‚è€Œä¸”é™æ€å®šä½å¾ˆéš¾â€œé‡å®šä½â€åˆ°å…¶ä»–ä½ç½®ã€‚

> ç•Œé™å¯„å­˜å™¨çš„æ£€æŸ¥æœºåˆ¶ï¼š
>
> - ç®—å‡ºç‰©ç†åœ°å€ä¹‹**å‰**å°±å®Œæˆäº†æ£€æŸ¥ï¼›
> - ç®—å‡ºåœ°å€ä¹‹**å**ï¼Œæ‹¿ç€ç‰©ç†åœ°å€å»compareæ£€æŸ¥ã€‚

#### ç¡¬ä»¶æ”¯æŒ

- **ç‰¹æƒæ“ä½œ**ï¼šé˜²æ­¢ç”¨æˆ·æ‰§è¡Œè¿™ä¸€ç³»åˆ—æ“ä½œï¼›
- **åŸºå€/ç•Œé™å¯„å­˜å™¨**ï¼šper CPU
- **èƒ½å¤Ÿæ£€æŸ¥è®¿é—®åœ°å€æ˜¯å¦åˆæ³•**
- **ä¿®æ”¹åŸºå€/ç•Œé™å¯„å­˜å™¨çš„ç‰¹æƒæŒ‡ä»¤**ï¼šåœ¨ç”¨æˆ·ç¨‹åºå¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬è¦èƒ½è¿è¡ŒOSå¯¹å…¶è¿›è¡Œè®¾ç½®ï¼›
- **æ³¨å†Œå¼‚å¸¸çš„ç‰¹æƒæŒ‡ä»¤**ï¼šè¿™ä¸ªæŒ‡ä»¤å‘Šè¯‰ç¡¬ä»¶ï¼Œç›¸å…³å¼‚å¸¸å‘ç”Ÿåï¼Œæ‰§è¡Œä»€ä¹ˆä»£ç ï¼ˆTrap tableï¼‰
- **è¶Šç•Œ/ç”¨æˆ·å°è¯•ä½¿ç”¨ç‰¹æƒæŒ‡ä»¤æ—¶èƒ½ç›´æ¥è§¦å‘å¼‚å¸¸**

#### æ“ä½œç³»ç»Ÿæ”¯æŒ

- åˆ›å»ºè¿›ç¨‹çš„æ—¶å€™ï¼Œè¦å¸®è¿›ç¨‹æ‰¾åˆ°å¯¹åº”çš„åœ°å€ç©ºé—´ï¼ˆä»free listé‡Œé¢æ‰¾ï¼‰
- ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶å€™è¦æ¢å¤å’Œå­˜å‚¨åŸºå€å¯„å­˜å™¨å’Œç•Œé™å¯„å­˜å™¨
- å½“è¿›ç¨‹æ²¡æœ‰è¿è¡Œçš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥æ”¹å˜è¿›ç¨‹çš„åœ°å€ç©ºé—´copy themï¼‰

## åˆ†æ®µ

#### ä¸åˆ†æ®µçš„åå¤„

- ä¸€ä¸ªç¨‹åºä¸€å¨åœ°å€ç©ºé—´ä¼šé€ æˆå¤§å—çš„â€œç©ºé—²â€ç©ºé—´ï¼Œä¸åˆ©äºå†…å­˜çš„åˆ©ç”¨

#### åˆ†æ®µå’‹åˆ†

é¦–å…ˆæœ‰3ä¸ªæ®µï¼š

- ä»£ç æ®µ
- æ ˆ
- å †

æ¯ä¸ªæ®µå¯¹åº”ä¸€å¯¹åŸºå€/ç•Œé™å¯„å­˜å™¨ï¼ˆ`*begin`&`size`ï¼‰ï¼›

#### æ®µé”™è¯¯

ç®€å•æ¥è¯´ï¼Œå³å½“MMUå°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€çš„æ—¶å€™ï¼Œå‘ç°ä¸åœ¨è‡ªå·±å¯¹åº”çš„æ®µä¸­ã€‚

æ³¨æ„è¿™äº›æ®µåœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸Šæ˜¯è¿ç»­çš„ï¼Œä½†åœ¨ç‰©ç†åœ°å€ä¸Šä¸ä¸€å®šæ˜¯è¿ç»­çš„ã€‚

#### æ®µæŸ¥æ‰¾

> å³ç»™æˆ‘ä¸€ä¸ªè™šæ‹Ÿåœ°å€æˆ‘è¯¥å¦‚ä½•ç®—å‡ºå…¶å¯¹åº”å“ªä¸ªæ®µï¼›

- ç”¨å‰å‡ ä¸ªbitæ¥æ ‡è¯†ï¼ˆVAX/VMSå°±è¿™ä¹ˆå¹²çš„ï¼‰ï¼ˆæ¯”å¦‚æˆ‘æœ‰3ä¸ªæ®µï¼Œæˆ‘ç”¨2ä¸ªbitï¼Œæœ‰çš„æ“ä½œç³»ç»Ÿç›´æ¥æŠŠæ ˆå’Œå †æ”¾ä¸€ä¸ªæ®µï¼Œè¿™æ ·åªè¦1bitï¼‰
- é™¤äº†å‰å‡ ä¸ªbitï¼Œå…¶ä»–éƒ½æ˜¯æ®µåç§»é‡ï¼›
- éæ³•æƒ…å†µï¼šå¦‚æœæ®µçš„åç§»åœ°å€å¤§äºå¯¹åº”çš„æ®µé•¿ï¼Œé‚£ä¹ˆå°±è§¦å‘å¼‚å¸¸ä¸­æ–­ï¼›

> ç¡¬ä»¶ä¹Ÿå¯ä»¥éšå¼çš„ç¡®å®šæ®µï¼š
>
> - å¦‚æœæ˜¯å–æŒ‡ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯ä»£ç æ®µï¼›
> - å¦‚æœç”¨åˆ°äº†åŸºå€æŒ‡é’ˆå’Œæ ˆé¡¶æŒ‡é’ˆï¼Œé‚£å°±æ˜¯æ ˆï¼›

#### å¢é•¿æ–¹å‘æ ‡è®°

å¯¹äºå„ä¸ªæ®µçš„å¢é•¿æ–¹å‘ä¼šæœ‰æ ‡è®°çš„ï¼ˆæ¯”å¦‚æœ‰çš„ç³»ç»Ÿçš„æ ˆæ˜¯åå‘å¢é•¿ï¼ŒLinuxçš„å †æ˜¯åå‘å¢é•¿ï¼Œä¼šæœ‰ä¸ªbitæ¥è®°å½•çš„ï¼‰

#### æ®µå…±äº«

æ¯”å¦‚æœ‰çš„ç¨‹åºå¯ä»¥å…±äº«ä»£ç æ®µï¼›

æ“ä½œç³»ç»Ÿåœ¨é¢å¤–çš„ç¡¬ä»¶æ”¯æŒçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ç»™æ¯ä¸ªæ®µå¢åŠ ä¿æŠ¤ä½ï¼Œæ¯”å¦‚ä»£ç æ®µçš„ä¿æŠ¤ä½è¡¨è¾¾çš„æ„æ€å¯ä»¥æ˜¯ï¼šâ€œè¯»-æ‰§è¡Œâ€ï¼Œå…¶ä»–æ®µæ˜¯â€œè¯»-å†™â€ã€‚

#### æ®µçš„ç²’åº¦

æ—©æœŸçš„æ®µï¼Œä¸ºäº†èŠ‚çœå†…å­˜ï¼Œéƒ½æ¯”è¾ƒç»†ç²’åº¦(fine-grained)ï¼Œå³åˆ†æˆç™¾ä¸Šåƒä¸ªæ®µã€‚ç°ä»£æ“ä½œç³»ç»Ÿä¸€èˆ¬éƒ½æ˜¯ç²—ç²’åº¦(coarse-grained)ã€‚

#### æ“ä½œç³»ç»Ÿæ”¯æŒ

- ä¸Šä¸‹æ–‡åˆ‡æ¢è¦ä¿å­˜æ®µå¯„å­˜å™¨ï¼›
- ç®¡ç†ç©ºé—²å†…å­˜ç©ºé—´ï¼Œè‹¥ä¸ç®¡ç†ï¼Œä¼šé€ æˆå¾ˆå¤šçš„ç¢ç‰‡ï¼ˆå°±æ˜¯æœ‰å¾ˆå¤šå°å†…å­˜ï¼Œå› ä¸ºä»–å°æ‰€ä»¥ä»–ä¸èƒ½è¢«ç”¨æ¥åˆ†é…ä¸€ä¸ªæ®µï¼Œä¹Ÿä¸æ–¹ä¾¿æ‰©å……å·²æœ‰æ®µï¼Œä½†å®ƒå¾ˆå¤šï¼Œå°±æ˜¯è¯´å¦‚æœæˆ‘ç®¡ç†çš„å¥½çš„è¯ï¼Œä»–å¯ä»¥æ±‡èšæˆbig chunk of memory.ï¼‰
- å¤–éƒ¨ç¢ç‰‡è§£å†³æ–¹æ¡ˆï¼š
  - compactï¼ˆç´§å‡‘é‡æ’ï¼‰
  - æœ€ä¼˜åŒ¹é…
  - æœ€ååŒ¹é…
  - é¦–æ¬¡åŒ¹é…
  - ä¸‹æ¬¡åŒ¹é…(åœ¨æˆ‘ä»¬å­¦æ ¡è¯¾ä¸Šå°†å…¶ç§°ä¹‹ä¸º**å¾ªç¯é¦–æ¬¡é€‚åº”ç®—æ³•**)
  - ä¼™ä¼´ç®—æ³•

> å¦‚æœä¸€ä¸ªé—®é¢˜æœ‰å¾ˆå¤šç§è§£å†³æ–¹æ¡ˆï¼Œè¯´æ˜è¿™ä¸ªé—®é¢˜æ²¡æœ‰ç‰¹åˆ«å¥½çš„è§£å†³æ–¹æ¡ˆã€‚

## å†…å­˜ç®¡ç†ï¼ˆ*ï¼‰

- ä¸»å­˜ç©ºé—´ç®¡ç†
- åœ°å€å˜æ¢ï¼ˆåŸºå€å¯„å­˜å™¨å’Œç•Œé™å¯„å­˜å™¨ç®¡ç†æ®µï¼ŒåŒæ—¶è´Ÿè´£å†…å­˜ä¿æŠ¤ï¼‰
- å†…å­˜æ‰©å……
  - äº¤æ¢ï¼šæš‚å­˜åˆ°å¤–éƒ¨å­˜å‚¨å™¨ä¸­ï¼›
  - è¦†ç›–ï¼šå…±äº«ä¸»å­˜æ®µï¼›
- å†…å­˜å…±äº«ä¸ä¿æŠ¤

## <u>è¿ç»­</u>å†…å­˜åˆ†é…ï¼ˆ*ï¼‰

- å•ä¸€è¿ç»­åˆ†é…ï¼šå•ç”¨æˆ·ã€å•ä»»åŠ¡naive
- å›ºå®šåˆ†åŒºåˆ†é…ï¼šå¯¹æ¯ä¸ªè¿›ç¨‹åˆ†**å›ºå®š**å¤§å°çš„ç©ºé—´ï¼ˆä¸å˜ï¼‰
- å¯å˜åˆ†åŒºåˆ†é…ï¼š
  - æœ€ä½³åŒ¹é…
  - æœ€ååŒ¹é…
  - é¦–æ¬¡é€‚åº”
  - ä¸‹æ¬¡é€‚åº”
- å¯é‡å®šä½åˆ†åŒºåˆ†é…ï¼šæ•´ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´å¯¹åº”çš„ç‰©ç†åœ°å€å‘ç”Ÿäº†æ”¹å˜

## ç©ºé—²ç©ºé—´ç®¡ç†

ç©ºé—²å†…å­˜ç©ºé—´çš„ç®¡ç†å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªéƒ¨åˆ†æ˜¯ç¨‹åºå†…éƒ¨å¯¹è‡ªèº«å †å†…å­˜çš„ç®¡ç†ï¼Œå¦å¤–ä¸€ä¸ªéƒ¨åˆ†æ˜¯æ“ä½œç³»ç»Ÿè‡ªèº«å¯¹äºæ®µçš„ç®¡ç†ã€‚è¿™é‡Œä¸»è¦è®¨è®ºç¨‹åºå†…éƒ¨çš„å †ç®¡ç†ã€‚

#### ç›®æ ‡

- æ»¡è¶³å†…å­˜ç”³è¯·çš„è¯·æ±‚
- èŠ‚çœç©ºé—´
- é™ä½æ—¶é—´å¼€é”€

> ç®¡ç†å †ä¸Šå†…å­˜ç©ºé—´çš„æ•°æ®ç»“æ„ä¸€èˆ¬è¢«ç§°ä¹‹ä¸ºâ€œç©ºé—²é“¾è¡¨â€(Free List)ã€‚å½“ç¨‹åºçš„å †å†…å­˜ä¸è¶³çš„æ—¶å€™ï¼Œç”¨æˆ·ç¨‹åºå¯ä»¥é€šè¿‡`sbrk`è¿™æ ·çš„ç³»ç»Ÿè°ƒç”¨æ¥å‘å†…æ ¸ç”³è¯·å¢åŠ å †å†…å­˜ï¼Œæ“ä½œç³»ç»Ÿä¼šå¯¹å…¶åˆ†é…ä¸€ä¸ªæ–°çš„ç‰©ç†å†…å­˜é¡µï¼Œå¹¶å°†å…¶æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚

#### åº•å±‚æœºåˆ¶

- **Splittingåˆ†å‰²**ï¼šå¯¹äºä¸€ä¸ªå†…å­˜nodeï¼Œå…¶`node_size`å¤§äºæˆ‘æƒ³è¦ç”³è¯·çš„`alloc_size`ï¼Œé‚£ä¹ˆå°±å°†å…¶åˆ†å‰²æˆ`alloc_size`å’Œ`node_size-alloc_size`ï¼Œå‰è€…è¿”å›ç»™ç”¨æˆ·ï¼Œåè€…ç»§ç»­ç•™åœ¨`free_list`ä¸­ã€‚
- **Coalescingåˆå¹¶**ï¼šè°ƒç”¨`free`å½’è¿˜å†…å­˜çš„æ—¶å€™ï¼Œæ£€æŸ¥ä¸€ä¸‹åœ°å€ç©ºé—´ä¸Šè¿ç»­çš„nodeæ˜¯å¦ä¹Ÿæ˜¯freeçš„ï¼Œå¦‚æœæ˜¯çš„åˆ™åˆå¹¶ï¼ˆå¾—åˆ°æ›´å¤§çš„nodeï¼‰ã€‚

#### è¿½è¸ªå·²åˆ†é…çš„å†…å­˜

æˆ‘ä»¬åœ¨freeçš„æ—¶å€™ä¸éœ€è¦å‘Šè¯‰ç³»ç»Ÿè¦freeçš„å¤§å°ï¼Œå› ä¸ºåœ¨æˆ‘ä»¬è°ƒç”¨mallocçš„æ—¶å€™ï¼Œå·²ç»é¢å¤–å¢åŠ äº†ä¸€ä¸ª`header_t{ int size; int magic; }`ï¼Œé¦–å…ˆæ£€æŸ¥ä¸€ä¸‹magicæ˜¯ä¸æ˜¯æŸä¸ªäº‹å…ˆçº¦å®šå¥½çš„å€¼ï¼ˆæ¥æ£€æŸ¥è¿™å—åœ°æ–¹æ˜¯ä¸æ˜¯`header_t`ï¼Œæ¯”å¦‚`assert(hptr->magic == 1234567)`ï¼‰ï¼Œå¦‚æœæ˜¯é‚£ä¹ˆå°±åœ¨å½“å‰ä½ç½®free sizeå¤§å°çš„å†…å­˜ã€‚

#### ç©ºé—²é“¾è¡¨çš„è¡¨ç»“æ„

> åˆ‡è®°ï¼Œç©ºé—²é“¾è¡¨å°±æ˜¯ä¸ªé“¾è¡¨ï¼Œä¸Šé¢å­˜ç€**â€œä¸è¿ç»­â€**ï¼ˆå‡è®¾è¿ç»­çš„ç©ºé—²å†…å­˜æˆ‘ä»¬å·²ç»åˆå¹¶å¥½äº†ï¼‰çš„ç©ºé—²å†…å­˜è®°è½½å—ã€‚é‚£ä¹ˆæ¯ä¸ªèŠ‚ç‚¹è¦è®°å½•çš„ä¸œè¥¿å¾ˆç®€å•ï¼š
>
> - å†…å­˜å¤§å°`size`
> - ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä½ç½®`node_t* next`

é‚£ä¹ˆå¯¹äºä¸ç©ºé—²çš„èŠ‚ç‚¹æˆ‘ä»¬ä¹Ÿç»™ä»–åŠ ä¸Šä¸€ä¸ªè¡¨å¤´`header_t`ï¼ˆä¸Šé¢æåˆ°çš„ï¼‰ã€‚å½“ä¸€ä¸ªèŠ‚ç‚¹è¢«å½’è¿˜çš„æ—¶å€™ï¼Œé‚£ä¹ˆå°±å…ˆå°è¯•åˆå¹¶ï¼Œç„¶åå°†`header_t`æ”¹æˆ`node_t`ã€‚å¯¹äºä¸€ä¸ªç”³è¯·ï¼ˆè¦åŠ ä¸Šè¡¨å¤´çš„å¤§å°ï¼‰ï¼Œé‚£ä¹ˆå°±æ˜¯æ‰¾åˆ°è¶³å¤Ÿå¤§çš„nodeï¼Œç„¶åsplitã€‚

## åŒ¹é…ç­–ç•¥

#### ä¸€èˆ¬ä½†é€šç”¨çš„ç­–ç•¥

- æœ€ä¼˜åŒ¹é…ï¼šæ‰¾åˆ°æ»¡è¶³å¤§å°çš„æœ€å°å—
  - éœ€è¦éå†æ•´ä¸ªlist
- æœ€å·®åŒ¹é…ï¼šæ‰¾åˆ°æ»¡è¶³å¤§å°çš„æœ€å¤§å—
  - å…¶åˆè¡·æ˜¯ä¸ºäº†è®©å—å°½é‡éƒ½æ¯”è¾ƒå¤§ï¼Œä½†å®è·µæ•ˆæœä¸å¥½
  - éœ€è¦éå†æ•´ä¸ªlistï¼Œæ•ˆç‡ä¸å¥½
- é¦–æ¬¡åŒ¹é…ï¼š
  - æ•ˆç‡å¥½
  - ä½†å®¹æ˜“é€ æˆlistå¼€å¤´ä¸€å †ç¢ç‰‡
  - å¯ä»¥é€šè¿‡å¯¹ç©ºé—²å—åœ°å€æ’åºï¼Œè®©å†…å­˜çš„ç”³è¯·å’Œå½’è¿˜é›†ä¸­åœ¨ä¸€å—åŒºåŸŸï¼Œä¹Ÿåˆ©äºåˆå¹¶æ“ä½œ
- ä¸‹æ¬¡åŒ¹é…ï¼šåœ¨é¦–æ¬¡åŒ¹é…çš„åŸºç¡€ä¸Šï¼Œä¿å­˜ä¸Šæ¬¡åŒ¹é…åˆ°çš„æŒ‡é’ˆ
  - é¿å…é€ æˆlistå¤´éƒ¨ä¸€å †ç¢ç‰‡è€Œä½¿æ•´ä¸ªéå†å˜å¾—ä½æ•ˆçš„æƒ…å†µ
  - åŒæ—¶è¿™æ ·åšæœ¬èº«ä¹Ÿèƒ½å‡å°‘å†…å­˜ç¢ç‰‡

#### åˆ†ç¦»ç©ºé—²é“¾è¡¨

å…¶å®å°±å¯¹è±¡æ± ï¼Œslab allocatorå°±è¿™ä¹ˆå¹²çš„ã€‚ï¼ˆå› ä¸ºä¹‹å‰çš„é—®é¢˜ä¸»è¦æ˜¯æœ‰å†…å­˜blockå¤§å°ä¸ä¸€è‡´å¯¼è‡´çš„ï¼Œå¦‚æœblockå¤§å°ä¸€è‡´å°±æ²¡è¿™ä¸ªé—®é¢˜äº†ï¼‰ã€‚ç„¶åslabçš„å›æ”¶é€šè¿‡å¼•ç”¨è®¡æ•°è®¡æ•°æ¥å®ç°ã€‚

#### ä¼™ä¼´ç³»ç»Ÿ

> ç”¨äºæ›´åŠ æ–¹ä¾¿çš„è¿›è¡Œmergeã€‚

ä»¥äºŒåˆ†ä¼™ä¼´ç³»ç»Ÿä¸ºä¾‹å­ï¼Œå¯¹äºä¸€ä¸ªå¤§çš„å†…å­˜å—ï¼ˆå¤§å°ä¸º$2^N$bytesï¼‰ï¼Œä¸æ–­äºŒåˆ†ç›´è‡³æ°å¥½èƒ½coverè¯·æ±‚ï¼ˆç»™å‡ºå»çš„å—ä¹Ÿæ˜¯$2^K$bytesï¼Œæ‰€ä»¥æœ‰å¯èƒ½ä¼šæœ‰å†…éƒ¨ç¢ç‰‡ï¼‰ã€‚ç„¶åå…¶é‡Šæ”¾çš„æ—¶å€™ï¼Œå°è¯•å»mergeéš”å£çš„ä¼™ä¼´å—ã€‚

## å…¶ä»–

#### ä¼˜åŒ–

å¯ä»¥ç”¨å…¶ä»–æ•°æ®ç»“æ„æ¥ä¼˜åŒ–æŸ¥æ‰¾å—çš„å¼€é”€ï¼š

- å¹³è¡¡äºŒå‰æ ‘
- åå±•æ ‘
- ååºæ ‘

é™¤æ­¤ä¹‹å¤–è¿˜éœ€è¦è€ƒè™‘å¤šçº¿ç¨‹æƒ…å†µä¸‹çš„å†…å­˜åˆ†é…é—®é¢˜ã€‚

#### Malloc&Free

è¿™ä¿©å¹¶ä¸æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œæ˜¯GLIBCè¿™æ ·çš„åº“é‡Œçš„å‡½æ•°ã€‚ä½†å…¶å¯èƒ½ä¼šå»callç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚`sbrk`ï¼Œ`mmap`ç­‰ã€‚

## åˆ†é¡µ

- é¡µå· ~ è™šæ‹Ÿåœ°å€ï¼ˆ32ä½å’Œ64ä½ä¸åŒï¼‰
- é¡µæ¡†å· ~ ç‰©ç†åœ°å€ï¼ˆçœ‹ç¡¬ä»¶ï¼‰

#### PTE

- **32ä½**ï¼š`(20 | 12)` 4KBçš„page
- **æœ‰æ•ˆä½**ï¼šæ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœæ— æ•ˆåˆ™ä¸ä¼šå¯¹å…¶åˆ†é…ç‰©ç†é¡µï¼›
- **å­˜åœ¨ä½**ï¼šçœ‹å…¶æ˜¯å¦åœ¨å†…å­˜/äº¤æ¢åŒºï¼›
- **ä¿æŠ¤ä½**ï¼š å³ä¸å…è®¸è®¿é—®çš„PTEï¼Œè‹¥è®¿é—®åˆ™ä¼šé™·å…¥æ“ä½œç³»ç»Ÿï¼›
- **è„ä½**ï¼šæ·˜æ±°ä¹‹å‰è¦å†™å›å†…å­˜ï¼›

## TLB

- CISC: ä¸»è¦æ˜¯Hardware
- RISC: å¯ä»¥Software
- **é‡ç‚¹åŒºåˆ†**ï¼šTLBæœ‰æ•ˆä½ `!=` é¡µè¡¨æœ‰æ•ˆä½ï¼šé¡µè¡¨ï¼ˆindexè¡¨ç¤ºä½ç½®ï¼‰å› ä¸ºä»£è¡¨çš„æ˜¯æ•´ä¸ªè¡¨çš„å†…å®¹ï¼Œeach address countsï¼Œå¦‚æœé¡µè¡¨çš„æœ‰æ•ˆä½æ˜¯0ï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªé¡µæ²¡æœ‰è¢«ç”³è¯·ã€‚è€ŒTLBæ˜¯cacheï¼Œåªæœ‰è¢«ç”¨åˆ°çš„é¡µè¡¨æ‰ä¼šè¢«è£…å…¥TLBï¼Œæ‰€ä»¥å…¶æœ‰æ•ˆä½è¡¨ç¤ºå½“å‰åœ°å€æ˜¯å¦æœ‰æ•ˆï¼ˆè‹¥æ— æ•ˆï¼Œåˆ™è¯´æ˜é‚£ä¸ªåœ°å€ä¸å…·æœ‰å®é™…æ„ä¹‰ï¼Œä¸èƒ½ä¿è¯è®¿é—®çš„æ­£ç¡®æ€§ï¼‰

> ä¸»è¦çœ‹çœ‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶TLBçš„è¡Œä¸ºï¼š
>
> // TODO.